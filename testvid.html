<!DOCTYPE html>
<html>
  <head>
   <meta charset = "utf-8" />
   <title>vid-eh-oh test </title>
<script src="base64.js" type="text/javascript"></script>
<script src="canvas2image.js" type="text/javascript"></script>
   
   <script>

var video;
var canvas;
var ctx ;
var localMediaStream = null;


  var onFailSoHard = function(e) {
    console.log('Reeeejected!', e);
  };
  
  function hasGetUserMedia() {
  // Note: Opera is unprefixed.
  return !!(navigator.getUserMedia || navigator.webkitGetUserMedia ||
            navigator.mozGetUserMedia || navigator.msGetUserMedia);
}

function getUserMedia() {

 return (navigator.getUserMedia || navigator.webkitGetUserMedia ||
            navigator.mozGetUserMedia || navigator.msGetUserMedia);
}


if (hasGetUserMedia()) {
  // Good to go!
} else {
  alert('getUserMedia() is not supported in your browser');
}
  
  
  function setPixel(imageData, x, y, r, g, b, a) {
    index = (x + y * imageData.width) * 4;
    imageData.data[index+0] = r;
    imageData.data[index+1] = g;
    imageData.data[index+2] = b;
    imageData.data[index+3] = a;
}

function getPixel(imageData, x, y) {
    index = (x + y * imageData.width) * 4;
    var retval = [];
    retval[index+0] = imageData.data[index+0];
    retval[index+1] = imageData.data[index+1];
    retval[index+2] = imageData.data[index+2];
    retval[index+3] = imageData.data[index+3];
    return retval;
}

function imagePump() {
  if (localMediaStream) {
    ctx.drawImage(video, 0, 0);
    
document.getElementById('display').src = canvas.toDataURL('image/webp');
//alert(video.videoWidth);
//ctx.width = video.src.width;
//ctx.height = video.src.height;
  
  
	}
		//alert("Copying");
               setTimeout("imagePump();", 100);
}

function snapBackground() {
    var data = document.getElementById('output').getContext('2d').getImageData(0,0,640,480);
    document.getElementById('background').getContext('2d').putImageData(data,0,0);
}

function makeForeground() {

    var data = document.getElementById('output').getContext('2d').getImageData(0,0,640,480);
    document.getElementById('newBackgroundCanvas').getContext('2d').drawImage(document.getElementById('newBackground'),0,0); 
    var newBackgroundData = document.getElementById('newBackgroundCanvas').getContext('2d').getImageData(0,0,640,480);

    var backgroundData = document.getElementById('background').getContext('2d').getImageData(0,0,640,480);

    var i;
    for ( i=0; i<data.data.length ; i=i+4) {
		if ( (1 + i)%4 == 0 ) { continue; }
               //alert(data.data[i]);
		//if (data.data[i] > 50) {
		var diff=Math.abs(data.data[i] - backgroundData.data[i])     +
		         Math.abs(data.data[i+1] - backgroundData.data[i+1]) +
		         Math.abs(data.data[i+2] - backgroundData.data[i+2])
		;
		//alert ("i: " + i + " diff: " + diff);
		if (Math.abs(diff)> 60) {
		  //it's the foreground, leave it
		} else {
		  data.data[i]=newBackgroundData.data[i];
		  data.data[i+1]=newBackgroundData.data[i+1];
		  data.data[i+2]=newBackgroundData.data[i+2];
		}
        }
    setTimeout("makeForeground()", 100);
    document.getElementById('foreground').getContext('2d').putImageData(data,0,0);
    
}


function temporalAverage() {
    document.getElementById('transform').getContext('2d').drawImage(document.getElementById('display'),0,0); 
               
               var data = document.getElementById('transform').getContext('2d').getImageData(0,0,640,480);
               var newdata = document.getElementById('output').getContext('2d').getImageData(0,0,640,480);
               var i;
               for ( i=0; i<data.data.length ; i=i+4 ) {
               //alert(data.data[i]);
		//if (data.data[i] > 50) {
		newdata.data[i]=newdata.data[i] + (1.0*data.data[i]-newdata.data[i])/3;
		newdata.data[i+1]=newdata.data[i+1] + (1.0*data.data[i+1]-newdata.data[i+1])/3;
		newdata.data[i+2]=newdata.data[i+2] + (1.0*data.data[i+2]-newdata.data[i+2])/3;
		newdata.data[i+3]=255;
		//alert(data.data[i]);
		//}
               }
               
               document.getElementById('output').getContext('2d').putImageData(newdata,0,0);
               setTimeout("temporalAverage();", 100);
}



function snapshot() {
imagePump();
temporalAverage();
return;

if (localMediaStream) {
    ctx.drawImage(video, 0, 0);
    // "image/webp" works in Chrome 18. In other browsers, this will fall back to image/png.
    document.getElementById('display').src = canvas.toDataURL('image/webp');
    // ctx;
    setTimeout(function() { document.getElementById('transform').getContext('2d').drawImage(document.getElementById('display'),0,0); 
               
               var data = document.getElementById('transform').getContext('2d').getImageData(0,0,640,480);
               var newdata = document.getElementById('output').getContext('2d').getImageData(0,0,640,480);
               var i;
               for ( i=0; i<data.data.length ; i=i+4 ) {
               //alert(data.data[i]);
		//if (data.data[i] > 50) {
		//data.data[i]=data.data[i]-(data.data[i]-newdata.data[i])/100;
		//data.data[i+1]=data.data[i]-(data.data[i+1]-newdata.data[i+1])/100;
		//data.data[i+2]=data.data[i]-(data.data[i+1]-newdata.data[i+2])/100;
		//data.data[i+3]=255;
		
		//}
               }
               
               document.getElementById('output').getContext('2d').putImageData(data,0,0);
               
               }
               , 1000);
               
    
  }
}

function start() {
video = document.querySelector('video');
canvas = document.querySelector('canvas');
ctx = canvas.getContext('2d');
localMediaStream = null;


video.addEventListener('click', snapshot, false);
//video.bind('loadedmetadata', function() { alert('hello');}, false);

// Not showing vendor prefixes or code that works cross-browser.
//navigator.getUserMedia({video: true}, function(stream) {
navigator.webkitGetUserMedia({video: true}, function(stream) {
video.src = window.URL.createObjectURL(stream);
  localMediaStream = stream;
//canvas.width = 640 ; //v.width;
//canvas.height = 480;

  }, onFailSoHard);

  }
  function savePic() {
  var oCanvas = document.getElementById("output");  
  
Canvas2Image.saveAsPNG(oCanvas);  // will prompt the user to save the image as PNG.  
  
//Canvas2Image.saveAsJPEG(oCanvas); // will prompt the user to save the image as JPEG.   
                                  // Only supported by Firefox.  
  
//Canvas2Image.saveAsBMP(oCanvas);  // will prompt the user to save the image as BMP.  
  
  
// returns an <img> element containing the converted PNG image  
//var oImgPNG = Canvas2Image.saveAsPNG(oCanvas, true);     
  
// returns an <img> element containing the converted JPEG image (Only supported by Firefox)  
//var oImgJPEG = Canvas2Image.saveAsJPEG(oCanvas, true);   
                                                         
// returns an <img> element containing the converted BMP image  
//var oImgBMP = Canvas2Image.saveAsBMP(oCanvas, true);   
  
  
// all the functions also takes width and height arguments.   
// These can be used to scale the resulting image:  
  
// saves a PNG image scaled to 100x100  
//Canvas2Image.saveAsPNG(oCanvas, false, 100, 100); 
  
  }



</script>
   </head>
  <body onLoad="start();">
  <video id='vid' autoplay></video>
<img id="display" style="display:none;" src="">
<canvas style="display:none;" width=640 height=480></canvas>

<canvas id="transform" style="display:none;" width=640 height=480></canvas>
<canvas id="output"  width=640 height=480 onClick="snapBackground()"></canvas>
<canvas id="background"  width=640 height=480 onClick="makeForeground();"></canvas>
<canvas id="foreground"  width=640 height=480></canvas>
<img id="newBackground" src="background.jpg" />
<canvas id="newBackgroundCanvas" width=640 height=480 />
<div onClick="savePic();" >Save Image</div>

  </body>
</html>